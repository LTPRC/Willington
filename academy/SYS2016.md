# SYS201 - Computer Networks - 缓存

返回[Bulletin](./bulletin.md)

返回[SYS301 - Distributed Systems](./SYS301.md)

[TOC]

## 缓存<img src="./icons/netease.gif" /><img src="./icons/mi.gif" />

所谓缓存，就是将程序或系统经常要调用的对象存在内存中，遍其使用时可以快速调用，不必再去创建新的重复的实例。这样做可以减少系统开销，提高系统效率。

### 分类

- 通过文件缓存。顾名思义文件缓存是指把数据存储在磁盘上，不管你是以XML格式、序列化文件、DAT格式，还是其它文件格式。

- 内存缓存。也就是实现一个类中静态Map，对这个Map进行常规的增删查。

### 缓存的特征<img src="./icons/mashibing.gif" />

#### 命中率

当某个请求能够通过访问缓存而得到响应时，称为缓存命中。

缓存命中率越高，缓存的利用率也就越高。

#### 最大空间

缓存通常位于内存中，内存的空间通常比磁盘空间小的多，因此缓存的最大空间不可能非常大。

当缓存存放的数据量超过最大空间时，就需要淘汰部分数据来存放新到达的数据。

#### 淘汰策略

- FIFO（First In First Out）：先进先出策略，在实时性的场景下，需要经常访问最新的数据，那么就可以使用 FIFO，使得最先进入的数据（最晚的数据）被淘汰。

- LRU（Least Recently Used）：最近最久未使用策略，优先淘汰最久未使用的数据，也就是上次被访问时间距离现在最久的数据。该策略可以保证内存中的数据都是热点数据，也就是经常被访问的数据，从而保证缓存命中率。

- LFU（Least Frequently Used）：最不经常使用策略，优先淘汰一段时间内使用次数最少的数据。

### 位置

#### 浏览器

当 HTTP 响应允许进行缓存时，浏览器会将 HTML、CSS、JavaScript、图片等静态资源进行缓存。

#### ISP

网络服务提供商（ISP）是网络访问的第一跳，通过将数据缓存在 ISP 中能够大大提高用户的访问速度。

#### 反向代理

反向代理位于服务器之前，请求与响应都需要经过反向代理。通过将数据缓存在反向代理，在用户请求反向代理时就可以直接使用缓存进行响应。

#### 本地缓存

使用 Guava Cache 将数据缓存在服务器本地内存中，服务器代码可以直接读取本地内存中的缓存，速度非常快。

#### 分布式缓存

使用 Redis、Memcache 等分布式缓存将数据缓存在分布式缓存系统中。

相对于本地缓存来说，分布式缓存单独部署，可以根据需求分配硬件资源。不仅如此，服务器集群都可以访问分布式缓存，而本地缓存需要在服务器集群之间进行同步，实现难度和性能开销上都非常大。

#### 数据库缓存

MySQL等数据库管理系统具有自己的查询缓存机制来提高查询效率。

#### Java内部的缓存

Java为了优化空间，提高字符串、基本数据类型包装类的创建效率，设计了字符串常量池及 Byte、Short、Character、Integer、Long、Boolean 这六种包装类缓冲池。

#### CPU多级缓存

CPU为了解决运算速度与主存 IO 速度不匹配的问题，引入了多级缓存结构，同时使用MESI等缓存一致性协议来解决多核CPU缓存数据一致性的问题。

### 缓存预热

缓存预热就是系统上线后，将相关的缓存数据直接加载到缓存系统，这样用户就可以直接查询事先被预热的缓存数据。从而避免在用户请求的时候先查询数据库，然后再将数据缓存。

### 缓存更新<img src="./icons/mashibing.gif" />

缓存更新，除了缓存服务器自带的缓存失效策略之外（Redis 默认的有6 中策略可供选择），我们还可以根据具体的业务需求进行自定义的缓存淘汰，常见的策略有两种：

- 定时去清理过期的缓存；
- 当有用户请求过来时，再判断这个请求所用到的缓存是否过期，过期的话就去底层系统得到新数据并更新缓存。

### 保证缓存与数据库的双写一致性<img src="./icons/paypal.gif" />

**Cache Aside Pattern**, 最经典的缓存+数据库读写的模式。

- 读的时候，先读缓存。缓存没有的话，就读数据库，然后取出数据后放入缓存。返回响应。

- 更新的时候，删除缓存，然后更新数据库。

为什么是删除缓存，而不是更新缓存？

- 复杂场景下缓存是结合多个表的数据计算出来的，这里结合了lazy计算的思想。

- 缓存更新成本有时很高。

### 缓存穿透<img src="./icons/pingan.gif" /><img src="./icons/baidu.gif" /><img src="./icons/paypal.gif" /><img src="./icons/didi.gif" />

一般的缓存系统，都是按照key去缓存查询，如果不存在对应的value，就应该去后端系统查找（比如DB）。如果key对应的value是一定不存在的，并且对该key并发请求量很大，就会对后端系统造成很大的压力。这就叫做缓存穿透。

#### 解决方案

- 对查询结果为空的情况也进行缓存，缓存时间设置短一点，或者该key对应的数据insert了之后清理缓存。

- 对一定不存在的key进行过滤。可以把所有的可能存在的key放到一个大的bitmap中，查询时通过该bitmap过滤。

### 缓存雪崩<img src="./icons/didi.gif" />

缓存雪崩我们可以简单的理解为：当缓存服务器重启、或者大量缓存集中在某一个时间段失效时，所有原本应该访问缓存的请求都去查询数据库了，从而对数据库CPU和内存造成巨大压力，严重的会造成数据库宕机。从而形成一系列连锁反应，造成整个系统崩溃。

#### 解决方案

- 在缓存失效后，通过加锁、使用队列排队，来控制读数据库写缓存的线程数量。比如对某个key只允许一个线程查询数据和写缓存，其他线程等待。

- 不同的key，设置不同的过期时间，让缓存失效的时间点尽量均匀。

- 做二级缓存，A1为原始缓存，A2为拷贝缓存，A1失效时，可以访问A2，A1缓存失效时间设置为短期，A2设置为长期。

- 给每一个缓存数据增加相应的缓存标记，记录缓存的是否失效。一旦失效则更新数据缓存。

### 缓存“无底洞”现象

指的是为了满足业务要求添加了大量缓存节点，但是性能不但没有好转反而下降了的现象。

#### 产生原因

缓存系统通常采用 hash 函数将 key 映射到对应的缓存节点，随着缓存节点数目的增加，键值分布到更多的节点上，导致客户端一次批量操作会涉及多次网络操作，这意味着批量操作的耗时会随着节点数目的增加而不断增大。此外，网络连接数变多，对节点的性能也有一定影响。

#### 解决方案

优化批量数据操作命令；

减少网络通信次数；

降低接入成本，使用长连接 / 连接池，NIO 等。

## 动态、静态资源分离<img src="./icons/pingan.gif" />

动态资源、静态资源分离是让动态网站里的动态网页根据一定规则把不变的资源和经常变的资源区分开来，动静资源做好了拆分以后，我们就可以根据静态资源的特点将其做缓存操作，这就是网站静态化处理的核心思路。

动态资源、静态资源分离简单的概括是：动态文件与静态文件的分离。

## CDN

CDN的全称是Content Delivery Network，即内容分发网络，它应用了 HTTP 协议里的缓存和代理技术，代替源站响应客户端的请求。主要有以下优点：

- 更快地将数据分发给用户；

- 通过部署多台服务器，从而提高系统整体的带宽性能；

- 多台服务器可以看成是一种冗余机制，从而具有高可用性。

一般包含分发服务系统、负载均衡系统和管理系统三部分：

### 分发服务系统

其基本的工作单元就是各个Cache服务器。负责直接响应用户请求，将内容快速分发到用户；同时还负责内容更新，保证和源站内容的同步。

根据内容类型和服务种类的不同，分发服务系统分为多个子服务系统，如：网页加速服务、流媒体加速服务、应用加速服务等。每个子服务系统都是一个分布式的服务集群，由功能类似、地域接近的分布部署的Cache 集群组成。

在承担内容同步、更新和响应用户请求之外，分发服务系统还需要向上层的管理系统反馈各个Cache 设备的健康状况、响应情况、内容缓存状况等，以便管理系统能够根据设定的策略决定由哪个Cache 设备来响应用户的请求。

### 负载均衡系统

负载均衡系统是整个CDN系统的中枢。负责对所有的用户请求进行调度，确定提供给用户的最终访问地址。

使用分级实现。最基本的两极调度体系包括全局负载均衡（GSLB）和本地负载均衡（SLB）。

- GSLB根据用户地址和用户请求的内容，确定向用户服务的节点。主要根据就近性原则，一般通过DNS解析或者应用层重定向（Http 3XX 重定向）的方式实现。

- SLB主要负责节点内部的负载均衡。当用户请求从GSLB 调度到SLB 时，SLB 会根据节点内各个Cache 设备的工作状况和内容分布情况等对用户请求重定向。SLB 的实现有四层调度（LVS）、七层调度（Nginx）和链路负载调度等。

### 管理系统

分为网络管理和运营管理两个子系统。

- 网络管理系统实现对CDN系统的设备管理、拓扑管理、链路监控和故障管理，为管理员提供对全网资源的可视化的集中管理，通常用web 方式实现。

- 运营管理是对CDN系统的业务管理，负责处理业务层面的与外界系统交互所必须的一些收集、整理、交付工作。包括用户管理、产品管理、计费管理、统计分析等。
