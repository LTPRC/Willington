# SYS201 - Computer Networks - IP协议

返回[Bulletin](./bulletin.md)

返回[SYS301 - Distributed Systems](./SYS301.md)

[TOC]

## IP协议<img src="./icons/kaikeba.gif" /><img src="./icons/mashibing.gif" /><img src="./icons/bytedance.gif" />

IP的全称是Internet Protocol, 互联网协议，主要解决的是通信双方寻址的问题。

IP协议是TCP/IP协议的核心，所有的TCP，UDP，IMCP，IGMP的数据都以IP数据格式传输。

要注意的是，IP不是可靠的协议，这是说，IP协议没有提供一种数据未传达以后的处理机制，这被认为是上层协议：TCP或UDP要做的事情。

目前主要有两种架构：IPv4和IPv6。

<img src="D:/workspace-spring-tool-suite-4-4.9.0.RELEASE/Willington/academy/images/SYS201047.png" />

### 广播地址

#### 本地广播

在本网络内广播的叫做**本地广播**。例如网络地址为 192.168.0.0/24 的情况下，广播地址是 192.168.0.255 。因为这个广播地址的 IP 包会被路由器屏蔽，所以不会到达 192.168.0.0/24 以外的其他链路上。

<img src="D:/workspace-spring-tool-suite-4-4.9.0.RELEASE/Willington/academy/images/SYS201049.png" />

#### 直接广播

在不同网络之间的广播叫做**直接广播**。例如网络地址为 192.168.0.0/24 的主机向 192.168.1.255/24 的目标地址发送 IP 包。收到这个包的路由器，将数据转发给 192.168.1.0/24，从而使得所有 192.168.1.1~192.168.1.254 的主机都能收到这个包（由于直接广播有一定的安全问题，多数情况下会在路由器上设置为不转发。）。

<img src="D:/workspace-spring-tool-suite-4-4.9.0.RELEASE/Willington/academy/images/SYS201050.png" />

### IPv4<img src="./icons/mashibing.gif" />

IPv4是目前应用最广泛的互联网协议，由于只能支持43亿设备所以不够用。包括以下阶段：

#### 分片 (Fragmentation)

把数据切成片，适配底层传输网络的大小要求。

可以选择不切片，但是底层协议有可能会选择直接丢掉大包。

#### 增加协议头 (IP Header)

<img src="D:/workspace-spring-tool-suite-4-4.9.0.RELEASE/Willington/academy/images/SYS201048.png" />

| 字段                | 含义                                                         |
| ------------------- | ------------------------------------------------------------ |
| Version             | 版本号                                                       |
| IHL                 | IP协议头长度，最大值15，代表15个双字。                       |
| Type of Service     | 服务类型，用来根据用户诉求选择支持低延迟、高吞吐量还是低丢包率。 |
| Total length        | 报文的总长度。                                               |
| Identification      | 报文ID, 用于排序。                                           |
| Fragment offset     | 偏移量，设置是否分片、分片的方式。                           |
| TTL (Time to live)  | 八位的TTL字段代表封包存活的时间，规定该数据包在穿过多少个路由之后才会被抛弃。某个IP数据包每穿过一个路由器，该数据包的TTL数值就会减少1，当该数据包的TTL成为零，它就会被自动抛弃。 |
| Protocal            | 上层使用的协议，例如TCP=6, UDP=17等。                        |
| Headern checksum    | 首部校验和，用来校验包是否被篡改过，以及数据是否被损坏。     |
| Source address      | 源IP.                                                        |
| Destination address | 目的IP.                                                      |
| Options             | 可选项。                                                     |

#### 路由&寻址 (Routing & Addressing)

若寻找的IP地址不在局域网内，需要路由找到去往对应网络的路径。

寻找网络编号32位IP地址和子网掩码255.0.0.0做&运算得到IP地址最顶层的网络号，例如：
$$
103.16.3.1 \& 255.0.0.0 = 103.0.0.0
$$
查询路由记录，用下一级的子网掩码获取下一站路由地址（网关），例如：
$$
103.16.3.1 \& 255.255.255.0 = 103.16.3.0
$$
网关是一个网络到另一个网络的通路，有时会在路由记录找到多个网关，造成重复封包。

最后进行数据转发。

### IPv6协议<img src="./icons/mashibing.gif" />

IPv6和IPv4两者工作原理相似，包括以下阶段：

#### 切片 (Fragmentation)

#### 增加封包头 (IP Header)

#### 路由&寻址 (Routing & Addressing)

##### 全局单播

- 站点前缀Site Prefix
  - 48-bit, 一般由地区性互联网注册机构分配给运营商。
- 子网号 Subnet ID
  - 16-bit, 用于站点内部区分子网。
- 接口号 Interface ID
  - 64-bit, 用于站点内部区分设备。

##### 本地单播

- Link-local前缀
  - 10-bit, 必须以fe80开头。

- 0
  - 54-bit.

- 接口号 Interface ID
  - 64-bit, 用于站点内部区分设备。

##### 分组多播

需要以ff00(8个1)开头，后面跟上一个分组的编号。要求所在的网络中已经定义了该分组编号和分组下设备的清单，而且有设备可以识别这个编号。根据清单，将数据发给对应的设备。

IPv4也支持分组多播，但由于地址紧张，需要网络配置整体配合。

### IPv4 VS IPv6<img src="./icons/mashibing.gif" />

|              | IPv4                             | IPv6                                                         |
| ------------ | -------------------------------- | ------------------------------------------------------------ |
| 地址大小     | 4*8=32位                         | 8*16=128位                                                   |
| 分隔符号     | 用"."分割地址，例如：103.28.7.32 | 用":"分割地址，例如：0123:4567:89ab:cdef:0123:4567:89ab:cdef |
| 书写简化     |                                  | 可以省略开头的0，可以用"::"省略若干组0000                    |
| 地址分配     | 资源稀缺，竞争分配               | 资源充足，随意分配                                           |
| 寻址方式     | 通过子网掩码计算网络地址         | 有固定的计算方式划分网络                                     |
| 地址解析策略 | 需要ARP协议                      | 通过无状态的邻居发现ND协议                                   |
| DNS记录      | A记录                            | AAAA记录                                                     |

## NAT协议<img src="./icons/mashibing.gif" />

用于拆分子网。

## ARP协议<img src="./icons/mashibing.gif" />

ARP (Address Resolution Protocol)协议是根据IP地址获取MAC地址的一种协议，特点是每个节点存储许多额外信息。

使用ARP协议的典型情况 ：

- 新设备接入IPv4时，也需要使用ARP协议让其他设备知道自己的存在。

- 发送方是**主机**，要把IP数据报发送到**本网络**上的另一个主机。这时用ARP找到目的主机的硬件地址。

- 发送方是**主机**，要把 IP 数据报发送到**另一个网络**上的一个主机。这时用ARP找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。

- 发送方是**路由器**，要把 IP 数据报转发到**本网络**上的一个主机。这时用ARP找到目的主机的硬件地址。

- 发送方是**路由器**，要把 IP 数据报转发到**另一个网络**上的一个主机。这时用ARP找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。

主机首先查自己的ARP高速缓存（一个IP-MAC地址对应表缓存），如果查询的IP－MAC值对不存在，那么主机就向网络发送一个带有待查询IP地址的ARP协议广播包。收到这份广播的包的所有主机都会查询自己的IP地址，如果发现自己符合条件就准备好一个包含自己的MAC地址的ARP包传送给发送ARP广播的主机。广播主机拿到ARP包后会更新自己的ARP缓存，用新的ARP缓存数据准备好数据链路层的的数据包发送工作。

### IP地址

IP（网络层）则负责在「没有直连」的两个网络之间进行通信传输。

### MAC地址

MAC（数据链路层）的作用则是实现「直连」的两个设备之间通信。

### 交换机 VS 路由器<img src="./icons/bytedance.gif" />

|          | 交换机               | 路由器                 |
| -------- | -------------------- | ---------------------- |
| 实现     | 特定网络内的数据交换 | 不同网络之间的数据转发 |
| OSI层次  | 数据链路层           | 网络层                 |
| 寻址方式 | 根据MAC地址          | 根据IP地址             |
| 转发速度 | 相对较快             | 相对较慢               |

## RARP协议

RARP协议（逆地址解析协议）的工作与此相反，RARP使只知道自己硬件地址的主机能够知道其IP地址。这种主机往往是无盘工作站。因此RARP协议目前已很少使用。

## ND协议<img src="./icons/mashibing.gif" />

指邻居发现协议(Neighbour Discover Protocol).

当新设备接入IPv6时，需要使用ND协议为自己申请一个IP地址，不同于IPv4获取IP地址，IPv6可以自行生成一个IP地址，也更加无状态化，无需记录ARP缓存的额外信息，减少数据冗余带来的风险和负担。

当新设备需要发送信息时，需要使用ND协议广播查询目标设备。如果需要路由，还可以通过ND协议查找路由器。

## ICMP协议

IP协议并不是一个可靠的协议，它不保证数据被送达，那么，自然的，保证数据送达的工作应该由其他的模块来完成。其中一个重要的模块就是**ICMP**(网络控制报文)协议。

ICMP不是高层协议，而是IP层的协议。

当传送IP数据包发生错误。比如主机不可达，路由不可达等等，ICMP协议将会把错误信息封包，然后传送回给主机。给主机一个处理错误的机会，这也就是为什么说建立在IP层以上的协议是可能做到安全的原因。

<img src="D:/workspace-spring-tool-suite-4-4.9.0.RELEASE/Willington/academy/images/SYS201051.png" />

ICMP包头跟在IP头之后，其中类型字段大致可以分为两大类：

- **查询报文类型** 用于诊断的查询消息，ping命令就是利用这个消息实现的。
- **差错报文类型 **通知出错原因的错误消息。
